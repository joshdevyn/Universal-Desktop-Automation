name: ğŸ›¡ï¸ Safety Validation CI

on:
  push:
    branches: [ main, develop, master ]
  pull_request:
    branches: [ main, develop, master ]
  workflow_dispatch:

jobs:
  safety-validation:
    name: ğŸ›¡ï¸ Safety Validation
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
    
    - name: â˜• Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven
    
    - name: ğŸ” Make Safety Scripts Executable
      run: |
        chmod +x scripts/safety-lint.sh
        chmod +x scripts/safety-validate.sh
        ls -la scripts/
    
    - name: ğŸ” Run Basic Safety Linting
      run: |
        echo "ğŸ›¡ï¸ Running basic safety linting..."
        ./scripts/safety-lint.sh
    
    - name: ğŸ” Run Comprehensive Safety Validation
      run: |
        echo "ğŸ›¡ï¸ Running comprehensive safety validation..."
        ./scripts/safety-validate.sh
    
    - name: ğŸ“‹ Upload Safety Report (on failure)
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: safety-validation-report
        path: |
          target/safety-reports/
          scripts/
        retention-days: 30
    
    - name: âœ… Safety Validation Success
      if: success()
      run: |
        echo "ğŸ‰ All safety validations passed!"
        echo "ğŸ›¡ï¸ Feature files are SAFE for execution."

  build-and-test:
    name: ğŸ§ª Build and Test (Safety-First)
    runs-on: ubuntu-latest
    needs: safety-validation
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
    
    - name: â˜• Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven
    
    - name: ğŸ”§ Prepare Scripts
      run: |
        chmod +x scripts/*.sh
        chmod +x scripts/*.bat || true
    
    - name: ğŸ›¡ï¸ Maven Build with Safety Validation
      run: |
        echo "ğŸ›¡ï¸ Building with safety-first profile..."
        mvn clean compile test-compile -Psafe-testing
    
    - name: ğŸ§ª Run Tests (Safety Context Only)
      run: |
        echo "ğŸ§ª Running tests with safety validation enabled..."
        mvn test -Psafety-validation -Dmaven.test.failure.ignore=true
    
    - name: ğŸ“Š Upload Test Reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-reports
        path: |
          target/surefire-reports/
          target/cucumber-reports/
          target/reports/
        retention-days: 30
    
    - name: ğŸ“Š Upload Screenshots (on test failure)
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: test-screenshots
        path: |
          target/screenshots/
          target/debug/
        retention-days: 30

  security-scan:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    needs: safety-validation
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
    
    - name: â˜• Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven
    
    - name: ğŸ”’ Run OWASP Dependency Check
      run: |
        mvn org.owasp:dependency-check-maven:check
    
    - name: ğŸ“‹ Upload Security Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: security-report
        path: target/dependency-check-report.html
        retention-days: 30

  notify-results:
    name: ğŸ“¢ Notify Results
    runs-on: ubuntu-latest
    needs: [safety-validation, build-and-test, security-scan]
    if: always()
    
    steps:
    - name: ğŸ“¢ Safety Validation Results
      run: |
        if [[ "${{ needs.safety-validation.result }}" == "success" ]]; then
          echo "âœ… Safety validation PASSED - All feature files are safe!"
        else
          echo "âŒ Safety validation FAILED - Dangerous operations detected!"
          echo "ğŸš¨ CRITICAL: Do not merge until safety issues are resolved!"
        fi
        
        if [[ "${{ needs.build-and-test.result }}" == "success" ]]; then
          echo "âœ… Build and tests PASSED"
        else
          echo "âŒ Build or tests FAILED"
        fi
        
        if [[ "${{ needs.security-scan.result }}" == "success" ]]; then
          echo "âœ… Security scan PASSED"
        else
          echo "âš ï¸ Security scan found issues"
        fi
